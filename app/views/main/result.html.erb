<% content_for :title, "Report for '#{@result.source_title}'" %>
<% content_for :body_class, "article "%>

<div id="shareResults">
  <h3>Share these Results</h3>
  <%= text_field_tag 'url', result_url(@result.slug), :id => 'share_url', :readonly => 'readonly', :size => 30 %>
</div>

<div id="ltColumn">
  <div id="source_content">
    <% if @result.source_format == 'plain_text' -%>
    <%= simple_format formatted_content(@result) %>
    <% else -%>    
    <%= formatted_content(@result) %>
    <% end -%>
  </div>
  
  <div id="source">
    <span id="dateCreated">This page was created on: <span class="date"><%= @result.created_at.to_formatted_s(:day) %></span></span>
    <% unless @result.source_url.blank? -%>
    <span class="url"><%= link_to "View Original", @result.source_url %></span>
    <% end -%>
  </div>
</div>

<div id="rtColumnWrapper">

  <div id="rtColumn">
    <h3>The Report</h3>

    <div id="processingBar" style="display:none;">
      <img src="/images/spinner.gif" id="spinner"/>
      <span>Processing</span>
    </div>

    <% if (@result.entities.nil? || @result.entities.empty?) && @result.processed %>
    <p id="nothing_found">Sorry, no results found.</p>
    <% end -%>
    
    <% if @result.entities.nil? || @result.entities.empty? || @result.contribution_count == 0 -%>
    <div id="contribution_report" style="display:none;">
    <% else -%>
    <div id="contribution_report">
    <% end -%>
      <ul class="reportData">
      <% @result.entities.each do |recipient| -%>
        <% if recipient.contributors -%>
        <% recipient.contributors.each do |contributor| -%>
        <li>
          <%= link_to contributor.name, influence_explorer_url(contributor), "data-entity" => contributor.extracted_name %> has donated $<%= number_with_delimiter contributor.amount %> to <%= link_to recipient.name, influence_explorer_url(recipient), "data-entity" => recipient.name %>
        </li>
        <% end -%>
        <% end -%>
      <% end -%>
      </ul>
    </div>

    <% if @result.entities.nil? || @result.entities.empty? -%>
    <div id="extracted_entities" style="display:none;">
    <% else -%>
    <div id="extracted_entities">
    <% end -%>
      <h4>Points of Influence</h4>
      <ul class="reportData">
      <% @result.entities.each do |entity| -%>
        <% if entity.tdata_id.blank? && @result.status == "Entities Extracted" -%>
          <li><%= entity.name %></li>
        <% elsif entity.tdata_id -%>
          <li>
            <%= link_to entity.name, influence_explorer_url(entity), "data-entity" => entity.name %><br />
            
            <% if entity.tdata_count > 0 -%>
            <%= image_tag piechart_url(entity), :alt => "Chart for #{entity.name}" %><br />
            
              <% unless entity.top_industries.empty? -%>
              <div class="industries">
                <p>Top Contributing Industries</p>
                <ol>
                  <% entity.top_industries.each do |industry_name| -%>
                  <li><%= industry_name %></li>
                  <% end -%>
                </ol>
              </div>
              <% end -%>
            
              <%= link_to "More &raquo;".html_safe, influence_explorer_url(entity), :class => "ie_link" %>
            
            <% end -%>
          </li>
        <% end -%>
      <% end -%>
      </ul>
    </div>
    
  </div>
</div>
<div class="clear"></div>

<script type="text/javascript" charset="utf-8">

  var slug = '<%= @result.slug %>';
  var entityCount = <%= @result.entities.length %>;
  var resultStatus = '<%= @result.status %>';

</script>